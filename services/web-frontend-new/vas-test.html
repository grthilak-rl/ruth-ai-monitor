<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAS Streaming Test</title>
    <!-- Janus Mock for Testing -->
    <script src="janus-mock.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .badge {
            padding: 5px 10px;
            border-radius: 5px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        .connected { background-color: #4CAF50; }
        .disconnected { background-color: #f44336; }
        .error {
            padding: 10px;
            background-color: #ffebee;
            border: 1px solid #f44336;
            border-radius: 5px;
            margin-bottom: 20px;
            color: #d32f2f;
        }
        .devices {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        .device {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .device:hover {
            background-color: #f0f0f0;
        }
        .device.selected {
            border: 2px solid #2196F3;
            background-color: #e3f2fd;
        }
        .device h4 {
            margin: 0 0 5px 0;
            color: #333;
        }
        .device p {
            margin: 5px 0;
            font-size: 14px;
            color: #666;
        }
        .controls {
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            margin-right: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .start-btn {
            background-color: #2196F3;
            color: white;
        }
        .start-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .stop-btn {
            background-color: #f44336;
            color: white;
        }
        .stop-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .video-container {
            background-color: #000;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        video {
            width: 100%;
            max-height: 600px;
        }
        .logs {
            height: 300px;
            overflow-y: auto;
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid #ddd;
        }
        .log-entry {
            margin-bottom: 2px;
            padding: 2px 0;
        }
        .debug-info {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 11px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
        <div class="container">
        <h1>VAS Video Streaming Test</h1>
        
        <!-- Status -->
        <div class="status">
            <span class="badge" id="vas-status">VAS: Disconnected</span>
            <span class="badge" id="janus-status">Janus: Disconnected</span>
            <span class="badge" id="stream-status">Stream: Inactive</span>
        </div>
        
        <!-- Info Message -->
        <div style="background-color: #e8f5e8; border: 1px solid #4CAF50; border-radius: 5px; padding: 10px; margin-bottom: 20px;">
            <strong>üé≠ Current Mode: Janus Mock Testing</strong><br>
            Using a mock Janus library to test the streaming flow. VAS API connectivity confirmed ‚úÖ
            This will help us identify where the streaming issue occurs in the real implementation.
        </div>

        <!-- Error Display -->
        <div id="error-display" class="error" style="display: none;"></div>

        <!-- Debug Info -->
        <div class="debug-info">
            <strong>Debug Info:</strong><br>
            VAS API: <span id="vas-api-url">http://10.30.250.245:8000/api</span><br>
            Janus WS: <span id="janus-ws-url">ws://10.30.250.245:8188/janus</span><br>
            Devices: <span id="device-count">0</span><br>
            Selected: <span id="selected-device">None</span><br>
            Streaming: <span id="streaming-status">No</span>
        </div>

        <!-- Device Selection -->
        <div>
            <h3>Select Device:</h3>
            <div class="devices" id="devices-container">
                <div style="text-align: center; color: #666; padding: 20px;">
                    Loading devices...
                </div>
            </div>
        </div>

        <!-- Control Buttons -->
        <div class="controls">
            <button class="start-btn" id="start-btn" onclick="startStreaming()" disabled>Start Stream</button>
            <button class="stop-btn" id="stop-btn" onclick="stopStreaming()" disabled>Stop Stream</button>
        </div>

        <!-- Video Display -->
        <div>
            <h3>Video Feed:</h3>
            <div class="video-container">
                <video id="video" autoplay playsinline></video>
            </div>
        </div>

        <!-- Logs -->
        <div>
            <h3>Logs:</h3>
            <div class="logs" id="logs"></div>
        </div>
    </div>

    <script>
        // Global variables
        let vasToken = null;
        let devices = [];
        let selectedDevice = null;
        let streaming = false;
        let janus = null;
        let pluginHandle = null;

        const VAS_API_URL = 'http://10.30.250.245:8000/api';
        const JANUS_WS_URL = 'ws://10.30.250.245:8188/janus';

        // Logging function
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logsContainer = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
            console.log(message);
        }

        // Update status badges
        function updateStatus() {
            document.getElementById('vas-status').textContent = `VAS: ${vasToken ? 'Connected' : 'Disconnected'}`;
            document.getElementById('vas-status').className = `badge ${vasToken ? 'connected' : 'disconnected'}`;
            
            document.getElementById('janus-status').textContent = `Janus: ${janus ? 'Connected' : 'Disconnected'}`;
            document.getElementById('janus-status').className = `badge ${janus ? 'connected' : 'disconnected'}`;
            
            document.getElementById('stream-status').textContent = `Stream: ${streaming ? 'Active' : 'Inactive'}`;
            document.getElementById('stream-status').className = `badge ${streaming ? 'connected' : 'disconnected'}`;
            
            // Update debug info
            document.getElementById('device-count').textContent = devices.length;
            document.getElementById('selected-device').textContent = selectedDevice ? selectedDevice.name : 'None';
            document.getElementById('streaming-status').textContent = streaming ? 'Yes' : 'No';
        }

        // Show error
        function showError(message) {
            const errorDiv = document.getElementById('error-display');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            addLog(`‚ùå Error: ${message}`);
        }

        // Clear error
        function clearError() {
            document.getElementById('error-display').style.display = 'none';
        }

        // Authenticate with VAS
        async function authenticateWithVAS() {
            try {
                addLog('üîê Authenticating with VAS...');
                const response = await fetch(`${VAS_API_URL}/auth/login-json`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Authentication failed: ${response.status}`);
                }

                const data = await response.json();
                vasToken = data.access_token;
                addLog('‚úÖ VAS Authentication successful');
                updateStatus();
                return data.access_token;
            } catch (error) {
                addLog(`‚ùå VAS Authentication failed: ${error.message}`);
                showError(`Authentication failed: ${error.message}`);
                return null;
            }
        }

        // Fetch VAS devices
        async function fetchVASDevices() {
            if (!vasToken) return;

            try {
                addLog('üì± Fetching VAS devices...');
                const response = await fetch(`${VAS_API_URL}/devices/`, {
                    headers: {
                        'Authorization': `Bearer ${vasToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch devices: ${response.status}`);
                }

                const data = await response.json();
                devices = data.devices || [];
                addLog(`‚úÖ Found ${devices.length} VAS devices`);
                
                renderDevices();
                updateStatus();
            } catch (error) {
                addLog(`‚ùå Failed to fetch VAS devices: ${error.message}`);
                showError(`Failed to fetch devices: ${error.message}`);
            }
        }

        // Render devices
        function renderDevices() {
            const container = document.getElementById('devices-container');
            container.innerHTML = '';

            if (devices.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No devices found</div>';
                return;
            }

            devices.forEach(device => {
                const deviceDiv = document.createElement('div');
                deviceDiv.className = 'device';
                deviceDiv.onclick = () => selectDevice(device);
                
                deviceDiv.innerHTML = `
                    <h4>${device.name}</h4>
                    <p>${device.location}</p>
                    <span class="badge ${device.status === 'online' ? 'connected' : 'disconnected'}">${device.status}</span>
                `;
                
                container.appendChild(deviceDiv);
            });
        }

        // Select device
        function selectDevice(device) {
            selectedDevice = device;
            
            // Update UI
            document.querySelectorAll('.device').forEach(div => {
                div.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Update buttons (allow start button even without Janus for testing)
            document.getElementById('start-btn').disabled = !selectedDevice || !vasToken || streaming;
            
            updateStatus();
            addLog(`üì± Selected device: ${device.name}`);
        }

        // Initialize Janus
        function initializeJanus() {
            return new Promise((resolve, reject) => {
                // Check if Janus is loaded
                if (typeof Janus === 'undefined') {
                    addLog('‚ùå Janus library not found. Checking CDN...');
                    
                    // Try to load from alternative CDN
                    const script = document.createElement('script');
                    script.src = 'https://unpkg.com/janus-gateway@1.3.3/janus.js';
                    script.onload = () => {
                        addLog('‚úÖ Janus library loaded from fallback CDN');
                        if (typeof Janus !== 'undefined') {
                            Janus.init({
                                debug: "all",
                                callback: () => {
                                    addLog('‚úÖ Janus library initialized');
                                    resolve();
                                }
                            });
                        } else {
                            reject(new Error('Janus library still not available after fallback load'));
                        }
                    };
                    script.onerror = () => {
                        reject(new Error('Failed to load Janus library from both CDNs'));
                    };
                    document.head.appendChild(script);
                    return;
                }

                addLog('‚úÖ Janus library found');
                Janus.init({
                    debug: "all",
                    callback: () => {
                        addLog('‚úÖ Janus library initialized');
                        resolve();
                    }
                });
            });
        }

        // Create Janus session
        function createJanusSession() {
            return new Promise((resolve, reject) => {
                janus = new Janus({
                    server: JANUS_WS_URL,
                    success: () => {
                        addLog('‚úÖ Janus session created');
                        updateStatus();
                        resolve(janus);
                    },
                    error: (error) => {
                        addLog(`‚ùå Janus session creation failed: ${error}`);
                        showError(`Janus connection failed: ${error}`);
                        reject(error);
                    },
                    destroyed: () => {
                        addLog('üßπ Janus session destroyed');
                        janus = null;
                        updateStatus();
                    }
                });
            });
        }

        // Start streaming
        async function startStreaming() {
            if (!vasToken || !selectedDevice) {
                showError('VAS token or device not available');
                return;
            }
            
            if (!janus) {
                showError('Janus library not available. This is expected in API-only mode. To test streaming, we need to fix the Janus library loading.');
                addLog('‚ÑπÔ∏è Janus library not available - this is expected in current API-only test mode');
                return;
            }

            try {
                streaming = true;
                clearError();
                addLog(`üé¨ Starting stream for ${selectedDevice.name}...`);

                // Get WebRTC config from VAS
                const configResponse = await fetch(`${VAS_API_URL}/monitoring/${selectedDevice.id}/webrtc`, {
                    headers: {
                        'Authorization': `Bearer ${vasToken}`
                    }
                });

                if (!configResponse.ok) {
                    throw new Error(`Failed to get WebRTC config: ${configResponse.status}`);
                }

                const config = await configResponse.json();
                addLog(`üì∫ WebRTC Config received for stream ${config.webrtc_config.stream_id}`);

                // Attach to streaming plugin
                janus.attach({
                    plugin: "janus.plugin.streaming",
                    success: (pluginHandle) => {
                        addLog('‚úÖ Connected to streaming plugin');
                        window.pluginHandle = pluginHandle;

                        // Watch the stream
                        pluginHandle.send({
                            message: { request: "watch", id: config.webrtc_config.stream_id },
                            success: (result) => {
                                addLog('üì∫ Watch request sent successfully');
                            },
                            error: (error) => {
                                addLog(`‚ùå Watch request failed: ${JSON.stringify(error)}`);
                                showError(`Watch request failed: ${JSON.stringify(error)}`);
                            }
                        });
                    },
                    error: (error) => {
                        addLog(`‚ùå Plugin attach failed: ${error}`);
                        showError(`Plugin attach failed: ${error}`);
                        streaming = false;
                        updateStatus();
                    },
                    onmessage: (msg, jsep) => {
                        addLog('üì® Plugin message received');
                        
                        if (jsep) {
                            addLog('üé¨ SDP offer received');
                            pluginHandle.createAnswer({
                                jsep: jsep,
                                media: { audioSend: false, videoSend: false, audioRecv: false, videoRecv: true },
                                success: (answerJsep) => {
                                    addLog('‚úÖ SDP answer created');
                                    
                                    // Set up video track handling
                                    const pc = pluginHandle.webrtcStuff.pc;
                                    if (pc && document.getElementById('video')) {
                                        addLog('üé• Setting up video track handling');
                                        
                                        pc.ontrack = (event) => {
                                            addLog('üé• Video track received!');
                                            if (event.track && event.track.kind === 'video') {
                                                addLog('üé• Adding video to element');
                                                const stream = new MediaStream([event.track]);
                                                document.getElementById('video').srcObject = stream;
                                                
                                                document.getElementById('video').play().then(() => {
                                                    addLog('üéâ Video playing successfully!');
                                                }).catch((error) => {
                                                    addLog(`‚ùå Video play failed: ${error.message}`);
                                                    showError(`Video play failed: ${error.message}`);
                                                });
                                            }
                                        };
                                    }
                                    
                                    pluginHandle.send({
                                        message: { request: "start" },
                                        jsep: answerJsep
                                    });
                                },
                                error: (error) => {
                                    addLog(`‚ùå Answer creation failed: ${error}`);
                                    showError(`Answer creation failed: ${error}`);
                                }
                            });
                        }
                    },
                    onremotetrack: (track, mid, added) => {
                        addLog(`üé• Remote track: ${track?.kind}, added: ${added}`);
                        if (added && track.kind === 'video' && document.getElementById('video')) {
                            addLog('üé• Adding video track via onremotetrack');
                            const stream = new MediaStream([track]);
                            document.getElementById('video').srcObject = stream;
                            
                            document.getElementById('video').play().then(() => {
                                addLog('üéâ Video playing via onremotetrack!');
                            }).catch((error) => {
                                addLog(`‚ùå Video play failed: ${error.message}`);
                            });
                        }
                    },
                    oncleanup: () => {
                        addLog('üßπ Plugin cleanup');
                        window.pluginHandle = null;
                        streaming = false;
                        updateStatus();
                    }
                });

                updateStatus();
            } catch (error) {
                addLog(`‚ùå Streaming failed: ${error.message}`);
                showError(`Streaming failed: ${error.message}`);
                streaming = false;
                updateStatus();
            }
        }

        // Stop streaming
        function stopStreaming() {
            addLog('üõë Stopping stream...');
            if (window.pluginHandle) {
                window.pluginHandle.detach();
                window.pluginHandle = null;
            }
            const video = document.getElementById('video');
            if (video) {
                video.srcObject = null;
            }
            streaming = false;
            selectedDevice = null;
            updateStatus();
            
            // Clear device selection
            document.querySelectorAll('.device').forEach(div => {
                div.classList.remove('selected');
            });
        }

        // Initialize everything (with Janus Mock)
        async function initialize() {
            try {
                addLog('üöÄ Starting VAS API test with Janus Mock');
                
                // Initialize Janus Mock
                await initializeJanus();
                
                // Authenticate with VAS
                const token = await authenticateWithVAS();
                if (token) {
                    await fetchVASDevices();
                    await createJanusSession();
                }
            } catch (error) {
                addLog(`‚ùå Initialization failed: ${error.message}`);
                showError(`Initialization failed: ${error.message}`);
            }
        }

        // Start when page loads
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
