<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Janus Gateway Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        .video-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .camera-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f9f9f9;
        }
        .camera-card h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        video {
            width: 100%;
            max-width: 320px;
            height: 240px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #000;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .logs {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .connection-info {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåê WebSocket Janus Gateway Test</h1>
        <p>Testing direct WebSocket connection to Janus Gateway (bypassing library issues)</p>
        
        <div id="status" class="status info">Ready to test WebSocket connection</div>
        
        <div>
            <button onclick="testWebSocketConnection()">Test WebSocket Connection</button>
            <button onclick="createSession()">Create Janus Session</button>
            <button onclick="attachToStreaming()">Attach to Streaming Plugin</button>
            <button onclick="watchStream(1)">Watch Stream 1</button>
            <button onclick="watchStream(2)">Watch Stream 2</button>
            <button onclick="clearLogs()">Clear Logs</button>
        </div>
        
        <div id="video-container" class="video-container">
            <div class="camera-card">
                <h3>Camera 1 - Office</h3>
                <video id="video-1" autoplay playsinline muted></video>
                <div class="connection-info">Mountpoint ID: 1</div>
            </div>
            <div class="camera-card">
                <h3>Camera 2 - Lobby</h3>
                <video id="video-2" autoplay playsinline muted></video>
                <div class="connection-info">Mountpoint ID: 2</div>
            </div>
        </div>
        
        <div>
            <h3>Connection Logs</h3>
            <div id="logs" class="logs"></div>
        </div>
    </div>
    
    <script>
        const JANUS_WS_URL = 'ws://10.30.250.245:8188/janus';
        let websocket = null;
        let sessionId = null;
        let transactionId = 0;
        let pendingTransactions = new Map();
        let streamingHandles = new Map();

        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logsDiv = document.getElementById('logs');
            const logEntry = document.createElement('div');
            
            let logText = `[${timestamp}] ${message}`;
            if (data) {
                logText += ': ' + JSON.stringify(data, null, 2);
            }
            
            logEntry.textContent = logText;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            
            console.log(message, data || '');
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function generateTransactionId() {
            return 'tx_' + (++transactionId).toString().padStart(8, '0');
        }

        function sendMessage(message) {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                log('‚ùå WebSocket not connected');
                return null;
            }
            
            const txId = generateTransactionId();
            message.transaction = txId;
            
            log('üì§ Sending message', message);
            websocket.send(JSON.stringify(message));
            
            return txId;
        }

        function testWebSocketConnection() {
            log('üîç Testing WebSocket connection to Janus Gateway...');
            updateStatus('Connecting to WebSocket...', 'info');
            
            websocket = new WebSocket(JANUS_WS_URL);
            
            websocket.onopen = function(event) {
                log('‚úÖ WebSocket connected successfully');
                updateStatus('WebSocket connected', 'success');
            };
            
            websocket.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    log('üì• Received message', message);
                    handleJanusMessage(message);
                } catch (error) {
                    log('‚ùå Failed to parse message', error.message);
                }
            };
            
            websocket.onerror = function(error) {
                log('‚ùå WebSocket error', error);
                updateStatus('WebSocket error', 'error');
            };
            
            websocket.onclose = function(event) {
                log('üîå WebSocket connection closed', { code: event.code, reason: event.reason });
                updateStatus('WebSocket disconnected', 'warning');
                sessionId = null;
            };
        }

        function handleJanusMessage(message) {
            const txId = message.transaction;
            
            if (message.janus === 'success') {
                if (message.data && message.data.id) {
                    if (!sessionId) {
                        sessionId = message.data.id;
                        log(`‚úÖ Session created: ${sessionId}`);
                        updateStatus(`Session created: ${sessionId}`, 'success');
                    } else {
                        // Handle creation success
                        const handleId = message.data.id;
                        log(`‚úÖ Handle created: ${handleId}`);
                        
                        // Store the handle for the streaming plugin
                        if (pendingTransactions.has(txId)) {
                            const context = pendingTransactions.get(txId);
                            if (context.type === 'attach') {
                                streamingHandles.set(context.mountpoint || 'default', handleId);
                            }
                            pendingTransactions.delete(txId);
                        }
                    }
                }
            } else if (message.janus === 'event') {
                log('üìä Event received', message);
                
                // Handle streaming events
                if (message.plugindata && message.plugindata.plugin === 'janus.plugin.streaming') {
                    const data = message.plugindata.data;
                    log('üé¨ Streaming plugin event', data);
                    
                    if (data.streaming === 'event' && data.result) {
                        log('üì∫ Stream result', data.result);
                    }
                }
                
                // Handle SDP offers/answers
                if (message.jsep) {
                    log('üé¨ SDP received', message.jsep);
                    handleSDP(message.jsep, message.sender);
                }
            } else if (message.janus === 'error') {
                log('‚ùå Janus error', message);
                updateStatus(`Janus error: ${message.error.reason}`, 'error');
            } else if (message.janus === 'ack') {
                log('‚úÖ Message acknowledged');
            }
        }

        function createSession() {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                log('‚ùå WebSocket not connected. Please test connection first.');
                return;
            }
            
            log('üîó Creating Janus session...');
            updateStatus('Creating session...', 'info');
            
            const message = {
                janus: 'create'
            };
            
            sendMessage(message);
        }

        function attachToStreaming() {
            if (!sessionId) {
                log('‚ùå No session created. Please create session first.');
                return;
            }
            
            log('üé¨ Attaching to streaming plugin...');
            updateStatus('Attaching to streaming plugin...', 'info');
            
            const txId = generateTransactionId();
            const message = {
                janus: 'attach',
                plugin: 'janus.plugin.streaming',
                session_id: sessionId,
                transaction: txId
            };
            
            pendingTransactions.set(txId, { type: 'attach' });
            websocket.send(JSON.stringify(message));
        }

        function watchStream(mountpoint) {
            const handleId = streamingHandles.get('default');
            if (!handleId) {
                log(`‚ùå No streaming handle available. Please attach to streaming plugin first.`);
                return;
            }
            
            log(`üé¨ Watching stream ${mountpoint}...`);
            updateStatus(`Watching stream ${mountpoint}...`, 'info');
            
            const message = {
                janus: 'message',
                session_id: sessionId,
                handle_id: handleId,
                body: {
                    request: 'watch',
                    id: mountpoint
                }
            };
            
            sendMessage(message);
        }

        function handleSDP(jsep, sender) {
            log('üé¨ Handling SDP offer/answer', jsep);
            
            // Create RTCPeerConnection
            const pc = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            });
            
            pc.ontrack = function(event) {
                log('üé• Remote track received', event);
                const stream = event.streams[0];
                
                // Try to attach to video elements
                for (let i = 1; i <= 2; i++) {
                    const video = document.getElementById(`video-${i}`);
                    if (video && !video.srcObject) {
                        video.srcObject = stream;
                        log(`‚úÖ Video stream attached to video-${i}`);
                        updateStatus(`Video playing on camera ${i}`, 'success');
                        break;
                    }
                }
            };
            
            pc.oniceconnectionstatechange = function() {
                log(`üßä ICE connection state: ${pc.iceConnectionState}`);
            };
            
            if (jsep.type === 'offer') {
                pc.setRemoteDescription(jsep).then(() => {
                    log('‚úÖ Remote description set');
                    return pc.createAnswer();
                }).then(answer => {
                    log('üìù Created answer', answer);
                    return pc.setLocalDescription(answer);
                }).then(() => {
                    log('‚úÖ Local description set');
                    
                    // Send answer back to Janus
                    const handleId = streamingHandles.get('default');
                    if (handleId) {
                        const message = {
                            janus: 'message',
                            session_id: sessionId,
                            handle_id: handleId,
                            body: { request: 'start' },
                            jsep: pc.localDescription
                        };
                        sendMessage(message);
                    }
                }).catch(error => {
                    log('‚ùå SDP handling error', error);
                });
            }
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        // Initialize
        log('üöÄ WebSocket Janus Gateway Test initialized');
        updateStatus('Ready to test WebSocket connection', 'info');
    </script>
</body>
</html>
